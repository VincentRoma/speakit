{% extends 'base.html.twig' %}

{% block body %}
    {{ ws_client() }}
    <div id="edu-discussions" class="row">
        <div class="col-md-2 col-xs-2 list-discussions">
            <h5>Discussions</h5>
            <ul class="list-group">
                <li class="list-group-item">
                    <a class="list-group-item-search" href="{{ path('edu_speak_search') }}">
                        <i class="fa fa-weixin fa-2x"></i> Find Someone
                    </a>
                </li>
                {% for discussion in discussions %}
                    <li class="list-group-item">
                        <a class="list-group-item-picture" href="{{ path('fos_user_profile_show')}}">
                            {% if discussion.participants[1].facebookPicture %}
                                <img class="profile-picture" src="{{ app.user.facebookPicture }}" alt="Profil" />
                            {% elseif discussion.participants[1].file %}
                                <img class="profile-picture" src="{{ app.user.file }}" alt="Profil" />
                            {% else %}
                                <i class="fa fa-user fa-3x"></i>
                            {% endif %}
                        </a>
                        <a class="list-group-item-user" href="{{ path('chat_display',{'id': discussion.id}) }}">
                            <span>{{discussion.participants[1]}}</span>
                        </a>
                    </li>
                {% endfor %}
            </ul>
        </div>
    {% if discussion is defined %}
        <div class="col-md-10 col-xs-10 selected-discussions">
            <div class="row">
                <div class="col-md-12 col-xs-12">
                </div>
                <div class="col-md-12 col-xs-12">
                    <div class="panel panel-default panel-chat">
                        <div class="panel-body">
                            <ul id="chat_room">

                            </ul>
                        </div>
                    </div>
                    <div class="input-group col-md-10 col-md-offset-1 col-xs-10 col-xs-offset-1">
                        <input type="text" class="form-control" id="chat_input" placeholder="Type a message...">
                        <span class="input-group-btn">
                            <a class="btn btn-edu" id="btn_send">Send</a>
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.pubnub.com/pubnub-dev.js"></script>
    <!-- <script src="{{asset('front/js/eduspeak/chat.js')}}"></script> -->
    <script>
    (function(){
        "use strict";
        var PUBNUB_demo = PUBNUB.init({
            publish_key: 'pub-c-43fee2d2-8fc4-4b00-b424-dd315210e2c2',
            subscribe_key: 'sub-c-aca4aeda-be98-11e5-8408-0619f8945a4f',
            secret_key: 'sec-c-YzZhYjVmMTgtYjJmZS00ZTVlLTkwMTMtNWVhZTgyYWEzOTY0'
        });

        var id_user = Math.floor((Math.random() * 100000) + 1000);
        var channel = '{{discussion.token}}';
        PUBNUB_demo.subscribe({
            channel: channel,
            message: function(m){
                display_message(m);
            }
        });

        var display_message = function(m){
            if(m.user == id_user){
                $("#chat_room").append('<li class="alert alert-edu-invert">'+ m.text +'</li>');
            }else{
                $("#chat_room").append('<li class="alert alert-edu">'+ m.text +'</li>');
            }
        };

        var send_message = function(){
            var message = $("#chat_input").val();
            $("#chat_input").val('');
            PUBNUB_demo.publish({
                channel: channel,
                message: {"text": message, "user": id_user},
                callback : function(m){console.log(m)}
            });
        };
        $("#btn_send").click(send_message());

        $(document).keypress(function(e) {
            if(e.which == 13) {
                send_message();
            }
        });
    })();

    </script>
    {% else %}
        <div class="col-md-10 col-xs-10 selected-discussions">
            <div class="row">
                <div class="col-md-12 col-xs-12">
                    <h3 class="discussion-empty">Select a discussion</h3>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
{%  endblock %}
